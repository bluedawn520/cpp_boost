[TOC]

---

### 高性能的IO优化：

- 零拷贝技术
- I/O多路复用技术
- **页缓存（PageCache）技术**

---

### PageCache:

> 是操作系统对文件的缓存，用来减少对磁盘的 I/O 操作，以**页为单位**的，内容就是磁盘上的物理块。
>
> 页缓存能帮助程序对文件进行顺序读写的速度几乎接近于内存的读写速度，主要原因就是由于 OS 使用 PageCache 机制对读写访问操作进行了性能优化。

**页缓存读取策略**：

> 当进程发起一个读操作 （比如，进程发起一个 read() 系统调用），它首先会检查需要的数据是否在页缓存中：
>
> - **如果在**，则放弃访问磁盘，而直接从页缓存中读取。
> - **如果不在**，则内核调度块 I/O 操作从磁盘去读取数据，**并读入紧随其后的少数几个页面**（不少于一个页面，通常是三个页面），然后将数据放入页缓存中。

**页缓存写策略**：

> 当进程发起 write 系统调用写数据到文件中，先写到页缓存，然后方法返回。此时数据还没有真正的保存到文件中去，Linux 仅仅将页缓存中的这一页数据标记为 “脏”，并且被加入到**脏页链表**中。

> 然后，由 `flusher` 回写线程周期性将脏页链表中的页写到磁盘，让磁盘中的数据和内存中保持一致，最后清理“脏”标识。在以下三种情况下，脏页会被写回磁盘：
>
> - **空闲内存**低于一个特定阈值。
> - 脏页在内存中**驻留**超过一个**特定的阈值**时。
> - 当用户进程调用 `sync()` 和 `fsync()` 系统调用时。

----



### Linux I/O

![image-20230529233548425](\LinuxIO_pic\image-20230529233548425.png)

> 除了传统的 `Buffered IO` 可以比较自由的用 **偏移+长度** 的方式读写文件之外，`mmap`和 `Direct IO` 均有**数据按页对齐的要求**，`Direct IO` 还限制 **读写必须是底层存储设备块大小的整数倍**（甚至 Linux 2.4 还要求是文件系统逻辑块的整数倍）



![image-20230529233601898](LinuxIO_pic\image-20230529233601898.png)

> 在 Linux 下，文件的缓存习惯性的称之为 `Page Cache`，而更低一级的设备的缓存称之为 `Buffer Cache`。
>
> 这两个概念很容易混淆，这里简单的介绍下概念上的区别：`Page Cache` 用于缓存文件的内容，和文件系统比较相关。文件的内容需要**映射**到实际的物理磁盘，**这种映射关系由文件系统来完成**；`Buffer Cache` 用于缓存**存储设备块**（比如磁盘扇区）**的数据**，而不关心是否有文件系统的存在（文件系统的元数据缓存在 Buffer Cache 中）。

---







[深入理解 Linux 的 I/O 系统 (qq.com)](https://mp.weixin.qq.com/s/BXMADDWt_fCe5ST5zveHKw)

